<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WiFi Log Analyzer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 15px; padding: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        h1 { color: #667eea; text-align: center; margin-bottom: 30px; font-size: 2.5em; }
        .upload-section { background: #f8f9fa; padding: 25px; border-radius: 10px; margin-bottom: 30px; }
        label { display: block; font-weight: 600; margin-bottom: 8px; color: #333; }
        input[type="file"] { display: block; width: 100%; padding: 10px; border: 2px dashed #667eea; border-radius: 8px; background: white; cursor: pointer; margin-bottom: 20px; }
        .options { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .option-group { background: white; padding: 15px; border-radius: 8px; border: 1px solid #e0e0e0; }
        select { width: 100%; padding: 10px; border: 2px solid #667eea; border-radius: 5px; font-size: 14px; margin-top: 5px; }
        .checkbox-group { display: flex; align-items: center; margin-top: 10px; }
        .checkbox-group input[type="checkbox"] { width: 20px; height: 20px; margin-right: 10px; cursor: pointer; }
        button { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 15px 40px; font-size: 16px; font-weight: 600; border-radius: 8px; cursor: pointer; display: block; margin: 20px auto; }
        button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
        .chart-wrapper { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .chart-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        .chart-title-input { font-size: 1.3em; font-weight: 600; color: #333; border: 2px solid transparent; padding: 5px 10px; border-radius: 5px; background: white; flex: 1; min-width: 300px; }
        .chart-title-input:focus { outline: none; border-color: #667eea; }
        .chart-controls { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        .slider-control { display: flex; align-items: center; gap: 10px; background: white; padding: 8px 15px; border-radius: 8px; border: 1px solid #e0e0e0; }
        .slider-control label { margin: 0; font-size: 14px; white-space: nowrap; }
        .slider-control input[type="range"] { width: 150px; }
        .slider-control span { font-weight: 700; color: #667eea; min-width: 30px; text-align: center; }
        .copy-btn { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; border: none; padding: 10px 20px; font-size: 14px; font-weight: 600; border-radius: 8px; cursor: pointer; margin: 0; }
        .copy-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(67, 233, 123, 0.4); }
        canvas { max-height: 400px; }
        .status { text-align: center; padding: 15px; margin: 20px 0; border-radius: 8px; display: none; }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ“¡ WiFi Log Analyzer</h1>
        
        <div class="upload-section">
            <label for="jsonFile">Upload WiFi JSON Log File:</label>
            <input type="file" id="jsonFile" accept=".json">
            
            <label for="testFiles">Upload iperf3 or ping Files (multiple):</label>
            <input type="file" id="testFiles" accept=".txt,.log" multiple>
            
            <div class="options">
                <div class="option-group">
                    <label for="testType">Test File Type:</label>
                    <select id="testType">
                        <option value="iperf3">iperf3</option>
                        <option value="ping">ping</option>
                    </select>
                </div>
                
                <div class="option-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="showThroughput">
                        <label for="showThroughput">Show Performance on Same Plot</label>
                    </div>
                </div>
            </div>
            
            <button onclick="process()">Process Data</button>
        </div>
        
        <div id="status" class="status"></div>
        <div id="charts"></div>
    </div>

    <script>
        let json, tests = [], charts = {};

        document.getElementById('jsonFile').onchange = async (e) => {
            json = JSON.parse(await e.target.files[0].text());
            showStatus('WiFi JSON loaded!', 'success');
        };

        document.getElementById('testFiles').onchange = async (e) => {
            tests = [];
            for (let f of e.target.files) tests.push({name: f.name, text: await f.text()});
            showStatus(`${tests.length} test file(s) loaded!`, 'success');
        };

        function showStatus(msg, type) {
            let s = document.getElementById('status');
            s.textContent = msg;
            s.className = `status ${type}`;
            s.style.display = 'block';
            setTimeout(() => s.style.display = 'none', 3000);
        }

        function smooth(data, w) {
            if (w <= 1) return data;
            return data.map((_, i) => {
                let start = Math.max(0, i - Math.floor(w/2));
                let end = Math.min(data.length, i + Math.ceil(w/2));
                let win = data.slice(start, end).filter(v => v != null);
                return win.length ? win.reduce((a,b) => a+b, 0) / win.length : null;
            });
        }

        async function copyChart(id) {
            let inst = charts[id];
            if (!inst) return;
            let c = inst.chart;
            
            let origXGrid = c.options.scales.x.grid.display;
            let origYGrid = c.options.scales.y.grid.display;
            let origY1Grid = c.options.scales.y1 ? c.options.scales.y1.grid.display : null;
            
            c.options.scales.x.grid.display = true;
            c.options.scales.y.grid.display = true;
            c.options.scales.x.grid.color = 'rgba(0,0,0,0.1)';
            c.options.scales.y.grid.color = 'rgba(0,0,0,0.1)';
            if (c.options.scales.y1) {
                c.options.scales.y1.grid.display = true;
                c.options.scales.y1.grid.color = 'rgba(0,0,0,0.1)';
            }
            c.update();
            
            let bg = {
                id: 'bg',
                beforeDraw: (ch) => {
                    let ctx = ch.canvas.getContext('2d');
                    ctx.save();
                    ctx.globalCompositeOperation = 'destination-over';
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(0, 0, ch.width, ch.height);
                    ctx.restore();
                }
            };
            Chart.register(bg);
            c.update();
            
            try {
                let blob = await new Promise(r => c.canvas.toBlob(r));
                await navigator.clipboard.write([new ClipboardItem({'image/png': blob})]);
                showStatus('Chart copied!', 'success');
            } catch (err) {
                showStatus('Copy failed: ' + err.message, 'error');
            }
            
            Chart.unregister(bg);
            c.options.scales.x.grid.display = origXGrid;
            c.options.scales.y.grid.display = origYGrid;
            if (c.options.scales.y1) c.options.scales.y1.grid.display = origY1Grid;
            c.update();
        }

        function process() {
            if (!json || !tests.length) return showStatus('Upload files first!', 'error');
            document.getElementById('charts').innerHTML = '';
            charts = {};
            let idx = 0;
            let showPerf = document.getElementById('showThroughput').checked;
            let type = document.getElementById('testType').value;
            
            tests.forEach(test => {
                let lines = test.text.split('\n'), start, end, perf = [];
                
                if (type === 'iperf3') {
                    lines.forEach(l => {
                        let m = l.match(/^(\w{3}\s+\w{3}\s+\d+\s+\d{2}:\d{2}:\d{2}\s+\d{4})/);
                        if (m) {
                            let t = new Date(m[1]).getTime() / 1000;
                            if (!start) start = t;
                            end = t;
                            let th = l.match(/(\d+\.?\d*)\s+Mbits\/sec/);
                            if (th) perf.push(parseFloat(th[1]));
                        }
                    });
                } else {
                    lines.forEach(l => {
                        let m = l.match(/^(\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2})/);
                        if (m) {
                            let t = new Date(m[1]).getTime() / 1000;
                            if (!start) start = t;
                            end = t;
                            let lat = l.match(/time=(\d+\.?\d*)\s*ms/);
                            if (lat) perf.push(parseFloat(lat[1]));
                        }
                    });
                }
                
                if (!start || !end) return showStatus(`Bad timestamps in ${test.name}`, 'error');
                
                let data = json.filter(e => {
                    let t = new Date(e.timestamp).getTime() / 1000;
                    return t >= start && t <= end;
                });
                
                if (!data.length) return showStatus(`No data for ${test.name}`, 'error');
                
                let time = new Date(start * 1000).toLocaleString('en-CA', {timeZone: 'America/Toronto', hour12: false});
                let labels = data.map((_, i) => i);
                let ack = data.map(e => e.last_ack_snr);
                let rx = data.map(e => e.last_rx_snr);
                let noise = data.map(e => e.noise_floor);
                let sig = data.map(e => e.signal);
                
                let perfData = showPerf && perf.length ? {label: type === 'iperf3' ? 'Throughput (Mbps)' : 'Latency (ms)', data: perf, color: '#ff6b6b'} : null;
                
                makeChart(`SNR - ${time} (${test.name})`, labels, [{l: 'ACK SNR (dB)', d: ack, c: '#667eea'}, {l: 'RX SNR (dB)', d: rx, c: '#f093fb'}], perfData, idx++);
                makeChart(`Noise Floor - ${time} (${test.name})`, labels, [{l: 'Noise Floor (dBm)', d: noise, c: '#4facfe'}], perfData, idx++);
                makeChart(`Signal - ${time} (${test.name})`, labels, [{l: 'Signal (dBm)', d: sig, c: '#43e97b'}], perfData, idx++);
                
                if (!showPerf && perf.length) {
                    makeChart(`${type === 'iperf3' ? 'Throughput' : 'Latency'} - ${time} (${test.name})`, 
                        perf.map((_, i) => i), 
                        [{l: type === 'iperf3' ? 'Throughput (Mbps)' : 'Latency (ms)', d: perf, c: '#ff6b6b'}], 
                        null, idx++);
                }
            });
            
            showStatus('Done!', 'success');
        }

        function makeChart(title, labels, datasets, perfData, idx) {
            let box = document.createElement('div');
            box.className = 'chart-wrapper';
            
            let header = document.createElement('div');
            header.className = 'chart-header';
            
            let input = document.createElement('input');
            input.type = 'text';
            input.className = 'chart-title-input';
            input.value = title;
            header.appendChild(input);
            
            let controls = document.createElement('div');
            controls.className = 'chart-controls';
            
            let slider = document.createElement('div');
            slider.className = 'slider-control';
            slider.innerHTML = '<label>Smoothing:</label>';
            let range = document.createElement('input');
            range.type = 'range';
            range.min = 1;
            range.max = 50;
            range.value = 1;
            let span = document.createElement('span');
            span.textContent = '1';
            range.oninput = () => {
                span.textContent = range.value;
                updateChart(idx, parseInt(range.value));
            };
            slider.appendChild(range);
            slider.appendChild(span);
            controls.appendChild(slider);
            
            let copy = document.createElement('button');
            copy.className = 'copy-btn';
            copy.textContent = 'ðŸ“‹ Copy';
            copy.onclick = () => copyChart(idx);
            controls.appendChild(copy);
            
            header.appendChild(controls);
            box.appendChild(header);
            
            let canvas = document.createElement('canvas');
            box.appendChild(canvas);
            document.getElementById('charts').appendChild(box);
            
            let ds = datasets.map(d => ({label: d.l, data: d.d, borderColor: d.c, backgroundColor: d.c + '20', tension: 0.4, borderWidth: 3, pointRadius: 0, yAxisID: 'y'}));
            let scales = {
                x: {title: {display: true, text: 'Time (s)', font: {weight: 'bold'}}, grid: {color: 'rgba(0,0,0,0.05)'}},
                y: {title: {display: true, text: datasets[0].l, font: {weight: 'bold'}}, grid: {color: 'rgba(0,0,0,0.1)'}, position: 'left'}
            };
            
            if (perfData) {
                ds.push({label: perfData.label, data: perfData.data, borderColor: perfData.color, backgroundColor: perfData.color + '20', tension: 0.4, borderWidth: 3, pointRadius: 0, yAxisID: 'y1'});
                scales.y1 = {title: {display: true, text: perfData.label, font: {weight: 'bold'}}, grid: {drawOnChartArea: false}, position: 'right'};
            }
            
            let chart = new Chart(canvas, {
                type: 'line',
                data: {labels: labels, datasets: ds},
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    interaction: {mode: 'index', intersect: false},
                    plugins: {legend: {display: true, position: 'top'}},
                    scales: scales
                }
            });
            
            charts[idx] = {chart: chart, raw: datasets.map(d => d.d), perfRaw: perfData ? perfData.data : null};
        }

        function updateChart(idx, w) {
            let c = charts[idx];
            c.raw.forEach((r, i) => {
                c.chart.data.datasets[i].data = smooth(r, w);
            });
            if (c.perfRaw) {
                c.chart.data.datasets[c.raw.length].data = smooth(c.perfRaw, w);
            }
            c.chart.update();
        }
    </script>
</body>
</html>
